# Протокол взаимодействия клиента с устройством

Режим обмена: вопрос–ответ. Сообщения в формате JSON в текстовом виде, признак конца сообщения — символ перевода строки (`\n`). При разрыве соединения клиент переподключается.

---

## 1. Формат сообщений

Каждое сообщение (и запрос, и ответ) — JSON-объект с полями:

| Поле  | Описание |
|-------|----------|
| type  | Тип сообщения (строка), см. список типов ниже |
| data  | Тело сообщения (объект или null). В запросе — параметры, в ответе — результат |
| error | Строка с текстом ошибки; пустая при успехе |

---

## 2. Типы сообщений

| Тип | Направление | Назначение |
|-----|-------------|------------|
| GetStateHardware | запрос  | Получить состояние аппаратуры КДМ |
| StateHardware    | ответ   | Состояние аппаратуры |
| SetCommand       | запрос  | Отправить команду на устройство |
| GetSetup         | запрос  | Получить текущую конфигурацию |
| SetSetup         | запрос  | Записать конфигурацию |
| GetStatistics    | запрос  | Получить статистику |
| GetBlinds        | запрос  | Получить данные по планам/фазам/картам («шторы») |
| GetJournal       | запрос  | Получить журнал событий |
| GetLogers        | запрос  | Получить диагностические сообщения potop |
| GetPowerDevs     | запрос  | Получить состояние каналов управленяи контроллера |
| SetBlinds        | запрос  | Установить данные по планам/фазам/картам («шторы») |


Ответы на GetSetup, GetStatistics, GetBlinds, GetJournal приходят в поле `data` того же сообщения (тип в ответе может совпадать с типом запроса или быть соответствующим типом ответа).
Важное замечание:
  коды подсистем potop 
 	LevelKDM    = 1 // Сообшения обмена с контроллером
	LevelSMNP   = 2 // Сообшения подсистемы SMNP
	LevelTunel  = 3 // Сообшения подсистемы туннелирования команд для modbus
	LevelUG405  = 4 // Сообшения подсистемы UG405
	LevelModbus = 5 // Сообшения подсистемы modbus
	LevelUtopia = 6 // Сообшения подсистемы utopia
	LevelArcona = 7 // Сообшения подсистемы arcona

---

## 3. Запросы и ответы по типам

### GetStateHardware

- **Запрос:** тип `GetStateHardware`, поле `data` пустое или null.
- **Ответ:** в `data` — объект «состояние аппаратуры» со следующими полями.

| Поле | Описание |
|------|----------|
| Central | Управление центром (да) или локальное (нет) |
| Ready | Готовность |
| Connect | Есть связь с КДМ (да/нет) |
| Dark | Режим ОС — тёмное (да/нет) |
| AllRed | Режим «Кругом красный» (да/нет) |
| Flashing | Режим «Жёлтый мигающий» (да/нет) |
| SourceTOOB | Источник времени внешний (да/нет) |
| VPU | ВПУ включён (да/нет) |
| WatchDog | Таймаут управления, сек |
| Plan | Номер исполняемого плана |
| Phase | Номер исполняемой фазы |
| LastPhase | Номер предыдущей фазы (промтакт) |
| WeekCard, DayCard | Текущие недельная и суточная карты |
| ElapTimePk | Остаток времени фазы ПК, сек |
| ElapTimeCoord | Остаток до конца входа в координацию, сек |
| Autonom | Режим автоном (да/нет) |
| Source | Код управления: 0 — локально, 1 — по группам, 2 — по планам, 3 — ручное |
| Status | Статус КДМ (массив) |
| StatusDirs | Статусы по направлениям (массив) |
| Tmin | Последнее заданное Тмин (мин. длительность фазы) |
| MaskCommand | Последняя маска от Утопии |
| RealWatchDog | Остаток watchdog, сек |
| TOOBs | Счётчики по направлениям (массив) |
| TimeData | Время в контроллере (массив) |
| HoursAdd | Смещение часового пояса |
| TypeDevice | Ответ КДМ (serverid), массив |
| DeviceID | Тип устройства (например 0x58 — Inspectr, 0x59 — КДМ, 0x5A и т.д.) |
| Key3 | Концевой (дверь): открыто (да/нет) |
| LastOperation | Время последней операции |

---

### SetCommand

- **Запрос:** тип `SetCommand`, в `data` — объект команды.

| Поле | Описание |
|------|----------|
| plan | 0 — снять управление по плану |
| phase | 0 — снять управление по фазе |
| dark | Нет — отменить, да — включить режим ОС |
| allred | Нет — отменить, да — «Кругом красный» |
| flashing | Нет — отменить, да — «Жёлтый мигающий» |
| ru | Нет — отменить, да — ручное управление |
| restart | Да — перезапуск контроллера |

- **Ответ:** при успехе поле `error` пустое; при ошибке в `error` — текст.

---

### GetSetup

- **Запрос:** тип `GetSetup`, поле `data` пустое или null.
- **Ответ:** в `data` — объект конфигурации (Setup): имя, пути логов и БД, идентификатор, подсистемы Modbus, Utopia, SNMP, TrafficData, ModbusRadar, Elistar, Micro, Energy, Mgr, Tunel, Comsignal с их параметрами (устройства, порты, адреса, флаги и т.д.).

---

### SetSetup

- **Запрос:** тип `SetSetup`, в `data` — полный объект конфигурации (та же структура, что возвращает GetSetup).
- **Ответ:** при успехе — пустой `error`; при ошибке — текст в `error`.

После успешной записи конфигурации программа на устройстве перезагружается, требуется новое подключение.

---

### GetStatistics

- **Запрос:** тип `GetStatistics`, в `data` — объект фильтра.

| Поле | Описание |
|------|----------|
| type | Строка: `"all"` — всё из БД, `"last"` — последняя запись, `"period"` — за период |
| start | Начало периода (для type=period) |
| end | Конец периода (для type=period) |

- **Ответ:** в `data` — объект со срезами статистики: счётчики и занятости по времени (массивы объектов с полями время и значения).

---

### GetBlinds

- **Запрос:** тип `GetBlinds`, поле `data` пустое или null.
- **Ответ:** в `data` — объект с полями: Ready (данные прочитаны), Conflicts (таблица конфликтов направлений), DefineNaps (описание направлений), DefPhases (описание фаз), Rpu (резервный план), Plans (планы управления с линиями: тип, фаза, начало, конец), Year, Weeks, Days (годовые, недельные, суточные карты), Status, SerialNum.

---

### GetJournal

- **Запрос:** тип `GetJournal`, поле `data` пустое или null.
- **Ответ:** в `data` — объект с полем journal (массив строк — записи журнала).

---

## 4. Примеры JSON

Ниже приведены примеры отправляемых (клиент → устройство) и получаемых (устройство → клиент) сообщений. В конце каждой строки передаётся символ `\n`.

### GetStateHardware

**Отправка (запрос):**
```json
{"type":"GetStateHardware","data":null,"error":""}
```

**Получение (ответ, фрагмент):**
```json
{
  "type": "GetStateHardware",
  "data": {
    "Central": false,
    "Ready": true,
    "Connect": true,
    "Dark": false,
    "AllRed": false,
    "Flashing": false,
    "Plan": 1,
    "Phase": 2,
    "Source": 0,
    "Status": [0],
    "StatusDirs": [3, 7, 7],
    "WatchDog": 30,
    "RealWatchDog": 28,
    "Key3": false
  },
  "error": ""
}
```

### SetCommand

**Отправка — включить ручное управление:**
```json
{
  "type": "SetCommand",
  "data": {
    "message": "SetCommand",
    "plan": 0,
    "phase": 0,
    "dark": false,
    "allred": false,
    "flashing": false,
    "ru": true,
    "restart": false
  },
  "error": ""
}
```

**Отправка — перезапуск контроллера:**
```json
{
  "type": "SetCommand",
  "data": {
    "message": "SetCommand",
    "plan": 0,
    "phase": 0,
    "dark": false,
    "allred": false,
    "flashing": false,
    "ru": false,
    "restart": true
  },
  "error": ""
}
```

**Получение (успех):**
```json
{"type":"SetCommand","data":null,"error":""}
```

**Получение (ошибка):**
```json
{
  "type": "SetCommand",
  "data": null,
  "error": "описание ошибки"
}
```

### GetSetup

**Отправка (запрос):**
```json
{"type":"GetSetup","data":null,"error":""}
```

**Получение (ответ, фрагмент):**
```json
{
  "type": "GetSetup",
  "data": {
    "message": "SetupSubsystem",
    "Setup": {
      "Name": "Detector",
      "LogPath": "/var/log/detector.log",
      "Id": 1,
      "DbPath": "/var/lib/detector.db",
      "modbus": {
        "device": "/dev/ttyUSB0",
        "baudrate": 9600,
        "parity": "N",
        "uid": 1,
        "debug": false,
        "log": true,
        "min": 5,
        "old": false,
        "key3": true
      },
      "utopia": {
        "device": "/dev/ttyS0",
        "baudrate": 115200,
        "uid": 2,
        "debug": false,
        "lostControl": 3
      }
    }
  },
  "error": ""
}
```

### SetSetup

**Отправка:** в `data` — тот же объект конфигурации, что возвращает GetSetup (полностью или с изменёнными полями).

**Получение (успех):**
```json
{"type":"SetSetup","data":null,"error":""}
```

### GetStatistics

**Отправка — последняя запись:**
```json
{
  "type": "GetStatistics",
  "data": {
    "type": "last"
  },
  "error": ""
}
```

**Отправка — все записи:**
```json
{
  "type": "GetStatistics",
  "data": {
    "type": "all"
  },
  "error": ""
}
```

**Отправка — за период:**
```json
{
  "type": "GetStatistics",
  "data": {
    "type": "period",
    "start": "2025-02-01T00:00:00Z",
    "end": "2025-02-05T23:59:59Z"
  },
  "error": ""
}
```

**Получение (ответ):**
```json
{
  "type": "GetStatistics",
  "data": {
    "message": "",
    "counts": [
      {"time": "2025-02-05T12:00:00Z", "values": [10, 20, 5, 15]},
      {"time": "2025-02-05T12:05:00Z", "values": [12, 18, 7, 14]}
    ],
    "ocupaes": [
      {"time": "2025-02-05T12:00:00Z", "values": [1, 0, 1, 0]}
    ]
  },
  "error": ""
}
```

### GetBlinds

**Отправка (запрос):**
```json
{"type":"GetBlinds","data":null,"error":""}
```

**Получение (ответ, фрагмент):**
```json
{
  "type": "GetBlinds",
  "data": {
    "Ready": true,
    "Conflicts": {"Conflicts": {}},
    "DefineNaps": {"DefineNaps": {}},
    "DefPhases": {"DefPhases": {}},
    "RPU": {"Number": 0, "Type": 0, "Tcycle": 90, "Shift": 0, "Lines": []},
    "Plans": {"Plans": {}},
    "Year": {"Year": {}},
    "Weeks": {"Weeks": {}},
    "Days": {"Days": {}},
    "Status": [0],
    "SerialNum": [0, 0]
  },
  "error": ""
}
```

### GetJournal

**Отправка (запрос):**
```json
{"type":"GetJournal","data":null,"error":""}
```

**Получение (ответ):**
```json
{
  "type": "GetJournal",
  "data": {
    "journal": [
      "2025-02-05 10:00:00 Событие 1",
      "2025-02-05 10:05:00 Событие 2"
    ]
  },
  "error": ""
}
```

---

## 5. Какие запросы отправлять для каких действий

| Действие | Запрос (тип сообщения) |
|----------|------------------------|
| Узнать текущее состояние КДМ (режим, план, фаза, связь, ошибки) | GetStateHardware |
| Включить ручное управление | SetCommand с ru=true |
| Включить режим ОС (тёмное) | SetCommand: сначала ru=true, затем dark=true, ru=true |
| Включить «Жёлтый мигающий» | SetCommand: сначала ru=true, затем flashing=true, ru=true |
| Включить «Кругом красный» | SetCommand: сначала ru=true, затем allred=true, ru=true |
| Передать управление внешней системе (снять ручное) | SetCommand с ru=false |
| Перезапустить контроллер | SetCommand с restart=true |
| Задать произвольную команду (план, фаза, комбинация флагов) | SetCommand с нужными полями в data |
| Прочитать текущую конфигурацию | GetSetup |
| Изменить конфигурацию (далее — перезагрузка на устройстве) | SetSetup с полной структурой конфигурации в data |
| Получить статистику (вся, последняя или за период) | GetStatistics с нужным type и при необходимости start/end |
| Получить планы, фазы, карты («шторы») | GetBlinds |
| Получить журнал событий | GetJournal |

Рекомендуемый порядок: установить соединение, при необходимости периодически опрашивать состояние (GetStateHardware), при необходимости — статистику (GetStatistics) и журнал (GetJournal), команды отправлять по мере надобности через SetCommand с нужными полями в data.
